<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" 
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" 
      xmlns:v="urn:schemas-microsoft-com:vml">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <title>Google Maps API Example: GGeoXml KML Overlay</title>

<script type="text/javascript" src="http://www.google.com/jsapi"></script> 
<script type="text/javascript"> 
    google.load("maps", "3",  {other_params:"sensor=false"});

    var jsondata={};
    var aplist={};
    var poslist={};
    var lastpos;
    var lasttime=0;

    var map;
    var geoXml; 
    var toggleState = 1;

    function distance(X,Y) {

      var lat_diff=X.lat()-Y.lat();
      var lng_diff=X.lng()-Y.lng();

      return Math.sqrt(Math.pow(lat_diff,2)+Math.pow(lng_diff,2))

    }

    function autozoom() {

	var bounds = new google.maps.LatLngBounds ();
	for (a in aplist) {
	  bounds.extend (aplist[a].getPosition());
	}
	map.fitBounds (bounds);
    }

    //Tutti i limiti di distanza devono essere fatti in wilocate.py, senò actual_pos è falsato da loro 
    //Anche se non vengono correttamente visualizzati

    function update(text) {
	json=eval("(" + text + ")");

	for (b in json) { 

	  if(b>lasttime) {

	    lasttime=b
	    
	    if('position' in json[b]) {

		  var actual_pos = new google.maps.LatLng(json[b]['position'][0],json[b]['position'][1]);

		  if(!lastpos) {
		      
		      map.setCenter(actual_pos, 15); 
		      var marker = new google.maps.Marker({
			  position: actual_pos, 
			  map: map, 
			  icon: "http://maps.google.com/mapfiles/marker_white.png",
			  title:"Actual position"
		      });
		      
		     lastpos=marker;

		  }
		  else {

		      dist = distance(actual_pos,lastpos.getPosition());
		      // Tra 1.113 km e 111.3 m
		      if(dist > 0.001 && dist < 0.01) {

			map.setCenter(actual_pos, 15); 
			lastpos.setPosition(actual_pos);
			
		      }
		  }

	    }
	    
	    if('APs' in json[b])  {

		for (m in json[b]['APs']) {

		  var pos = new google.maps.LatLng(json[b]['APs'][m]['latitude'],json[b]['APs'][m]['longitude']);

		  if(m in aplist) {
		      
		  }
		  // < 111.3*3 m
		  else if(json[b]['APs'][m]['reliable']==1) {
		      
		      var marker = new google.maps.Marker({
			    position: pos, 
			    map: map, 
			    title:m
			});   

			aplist[m]=marker;
		  }


		  }
		}

 	  autozoom();


 	  }
	}

    }

    function initialize() {

      var client = new XMLHttpRequest();
      function handler() {

	if(client.readyState == 4 && client.status == 200) {
	  if(client.responseText != null && client.responseText != "") {
	    update(client.responseText);
	  }
	  else {
	    alert('Error getting json (null) ' + client.readyState + ' ' + client.status);
	  }
	} else if (client.readyState == 4 && client.status != 200) {
	  alert('Error getting json (!=200)');
	}
      }
       client.onreadystatechange = handler;
      client.open("GET", "http://localhost:8000/wilocate.json", true);
      client.send();   


      var myLatlng = new google.maps.LatLng(-34.397, 150.644);
      var myOptions = {
	zoom: 16,
	center: myLatlng,
	mapTypeId: google.maps.MapTypeId.HYBRID
      };
      map = new google.maps.Map(document.getElementById("map_canvas"),myOptions);

    } 


	</script>
  </head>

  <body onload="initialize()">
    <div id="map_canvas" style="width: 640px; height: 480px; float:left; border: 1px solid black;"></div>
    <br clear="all"/>
    <br/>
    <input type="button" value="Toggle KML" onClick="toggleMyKml();"/>
  </body>
</html>
