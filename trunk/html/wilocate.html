<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" 
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" 
      xmlns:v="urn:schemas-microsoft-com:vml">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <title>Google Maps API Example: GGeoXml KML Overlay</title>

<script type="text/javascript" src="http://www.google.com/jsapi"></script> 
<script type="text/javascript"> 
    google.load("maps", "3",  {other_params:"sensor=false"});

    var jsondata={};
    var aplist={};
    var poslist={};
    var lastpos;
    var lasttime=0;

    var map;
    var geoXml; 
    var toggleState = 1;

    function distance(X,Y) {

      var lat_diff=X.lat()-Y.lat();
      var lng_diff=X.lng()-Y.lng();

      return Math.sqrt(Math.pow(lat_diff,2)+Math.pow(lng_diff,2))

    }

    function autozoom() {

	var bounds = new google.maps.LatLngBounds ();
	for (a in aplist) {
	  bounds.extend (aplist[a].getPosition());
	}
	map.fitBounds (bounds);
    }

    function htmlify(j) {

	var blockprint = j['mac_address'] + '\n';

	if('address' in j) {
	  if ('country' in j['address'])
	    blockprint += j['address']['country'] + ' '; 
	    
	  if ('country_code' in j['address'])
	    blockprint +=  '(' + j['address']['country_code'] + ') ';
	    
	  if('region' in j['address'])
	    blockprint +=  j['address']['region'] + ' ';

	  if('postal_code' in j['address'])
	    blockprint +=  j['address']['postal_code'] + ' ';

	  if('county' in j['address'])
	    county = j['address']['county'] + ' ';
		  
	  if('city' in j['address'])
	    city = j['address']['city'] + ' ';

	  if (county != city)
	    blockprint +=  city + ' ' + county + ' ';
	  else if (!city)
	    blockprint +=  county + ' ';
	  else
	    blockprint +=  city + ' ';

	  if('street' in j['address'])
	    blockprint +=  j['address']['street'] + ' ';

	  if('street_number' in j['address'])
	    blockprint +=  j['address']['street_number'] + ' ';
	    
	  }
	blockprint += '(' + j['accuracy'] + ') ';
	return blockprint
    }

    function updateMarker(a) {


	var pos = new google.maps.LatLng(json[b]['APs'][m]['latitude'],json[b]['APs'][m]['longitude']);

	var marker = new google.maps.Marker({
	    position: pos, 
	    map: map, 
	    title:a['mac_address'],
	    icon:'ap.png',
	    title:htmlify(a)
	});   

	aplist[m]=marker;

	google.maps.event.addListener(marker, 'mouseover', function(event) {
// 	    alert(marker.getTitle());
	    document.getElementById('marker_info').innerHTML = htmlify(a);
	});



    }

    function update(text) {
	json=eval("(" + text + ")");

	for (b in json) { 

	  if(b>lasttime) {

	    lasttime=b
	    
	    if('APs' in json[b])  {

		for (m in json[b]['APs']) {

		  if(m in aplist) {
		      
		  }
		  else if(json[b]['APs'][m]['reliable']==1) {
		  
			updateMarker(json[b]['APs'][m]);
    
		  }


		  }
		}

	    if('position' in json[b]) {

		  var actual_pos = new google.maps.LatLng(json[b]['position'][0],json[b]['position'][1]);

		  if(!lastpos) {
		      
		      map.setCenter(actual_pos, 15); 
		      var marker = new google.maps.Marker({
			  position: actual_pos, 
			  map: map, 
			  title:"Actual position"
		      });
		      
		     lastpos=marker;

		  }
		  else {
		      dist = distance(actual_pos,lastpos.getPosition());
		      // Tra 1.113 km e 111.3 m
		      if(dist > 0.001) {

			map.setCenter(actual_pos, 15); 
			lastpos.setPosition(actual_pos);

		      }
		  }
	    }


	    autozoom();


 	  }
	}

    }

    function request() {

      setTimeout("request()",5000);

      var client = new XMLHttpRequest();
      function handler() {

	if(client.readyState == 4 && client.status == 200) {
	  if(client.responseText != null && client.responseText != "") {
	    update(client.responseText);
	  }
	  else {
	    toprint = 'Error getting json (null) ' + client.readyState + ' ' + client.status;
	    document.getElementById('marker_info').innerHTML = toprint;
	  }
	} else if (client.readyState == 4 && client.status != 200) {
	  toprint = 'Error getting json (!=200)';
	  document.getElementById('marker_info').innerHTML = toprint;
	}
      }

      client.onreadystatechange = handler;
      client.open("GET", "http://localhost:8000/wilocate.json", true);
      client.send();   

    }


    function initialize() {

      request()

      var myLatlng = new google.maps.LatLng(-34.397, 150.644);
      var myOptions = {
	zoom: 16,
	center: myLatlng,
	mapTypeId: google.maps.MapTypeId.HYBRID
      };
      map = new google.maps.Map(document.getElementById("map_canvas"),myOptions);

    } 


	</script>
  </head>

  <body onload="initialize()">
    <div id="map_canvas" style="width: 640px; height: 480px; float:left; border: 1px solid black;"></div>
    <div id="marker_info" style="width: 300px; height: 80px; float:right; border: 1px solid black;"></div>
    <br clear="all"/>
    <br/>
  </body>
</html>
